#!/bin/bash

timestamp=`date +%Y-%m-%d_%H%M%S`
echo "Program started at $timestamp"

o=output
r=$o/raw
p=$r/positive-cases
t=$r/tests
h=$r/hospital-bed-data
m=$o/misc
mkdir -p $p $t $h $m

f=FL-$timestamp.csv
caseLineFile=$p/$f
testsByCountyFile=$t/$f
hospitalBedFile=$h/$f

url1FLDOH="https://services1.arcgis.com/CY1LXxl9zlJeBuRZ/ArcGIS/rest/services"
url1Hospitals="https://services.arcgis.com/3wFbqsFPLeKqOlIK/ArcGIS/rest/services"
url2="FeatureServer/0/query?f=json&resultType=standard&where=1%3D1&returnGeometry=false&outFields=*"

down=download-raw-data.r

echo "Downloading confirmed COVID-19 data"
pURL="$url1FLDOH/Florida_COVID19_Case_Line_Data_NEW/$url2"
Rscript $down $pURL $p/ $caseLineFile
ret1=$?
echo $ret1

echo "Downloading COVID-19 testing data"
tURL="$url1FLDOH/Florida_Testing/$url2"
Rscript $down $tURL $t/ $testsByCountyFile
ret2=$?
echo $ret2

echo "Downloading AHCA data via FloridaCOVIDAction.com"
hURL="$url1Hospitals/HOSPITALS_esri/$url2"
Rscript $down $hURL $h/ $hospitalBedFile


if [[ $ret1 -eq 1 && $ret2 -eq 1 ]]; then
	echo "Exiting program"
	exit
fi

echo "Making data files for most charts."
od=$o/datawrapper
Rscript make-datafiles-for-charts.r $caseLineFile $testsByCountyFile $od $ret1 $ret2 $timestamp $t

echo "Making data files for coronavirus death charts."
Rscript deaths-by-date.r $p $od

echo "Making data files for Google Sheets for other reporters"
Rscript cases-reported-by-county-and-date.r $t $m

echo "Updating charts"
Rscript update-charts.r $timestamp $od/county.csv $od/south-fl.csv $ret1 $ret2
